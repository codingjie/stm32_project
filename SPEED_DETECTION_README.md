# STM32 PB7相位测速方案

## 概述
本方案使用STM32的TIM4输入捕获功能，通过测量PB7引脚上脉冲信号的周期来计算电机转速。此方法适用于Proteus仿真环境，避免了编码器模式的兼容性问题。

## 硬件连接
- **PB7**: 连接到编码器输出信号（TIM4_CH2）
- 只需要一根信号线，无需A/B双相编码器

## 工作原理

### 1. 输入捕获模式
- 使用TIM4的通道2（PB7）配置为输入捕获模式
- 定时器预分频为72，计数频率为1MHz（每计数1us）
- 捕获上升沿触发中断

### 2. 周期测量
```
第一次上升沿: 记录时间T1
第二次上升沿: 记录时间T2
脉冲周期 = T2 - T1 (微秒)
```

### 3. 转速计算
```
频率(Hz) = 1,000,000 / 周期(us)
转速(RPM) = (频率 / 每圈脉冲数) × 60
```

## 关键参数

### encoder.h 中的配置
```c
#define ENCODER_PPR 20  // 编码器每圈脉冲数
```

**重要**: 请根据您的实际电机编码器参数修改此值！

### 定时器配置
- **定时器**: TIM4
- **预分频**: 72 (72MHz → 1MHz)
- **最大计数**: 65535 (65.535ms)
- **分辨率**: 1us

## 溢出处理
- 如果两次脉冲间隔超过65.535ms，会发生定时器溢出
- 代码通过计数溢出次数来处理长周期
- 如果溢出超过100次（约6.5秒），判断电机停止，转速归零

## API接口

### 初始化函数
```c
void Encoder_Init(void);
```
初始化PB7输入捕获，配置TIM4和中断。

### 读取转速
```c
float Get_Motor_RPM(void);      // 返回转速(RPM)
float Get_Motor_Speed_Hz(void); // 返回脉冲频率(Hz)
```

## 使用示例

```c
int main(void) {
    // 系统初始化
    Encoder_Init();

    while(1) {
        float rpm = Get_Motor_RPM();
        float hz = Get_Motor_Speed_Hz();

        printf("转速: %.1f RPM, 频率: %.2f Hz\r\n", rpm, hz);
        delay_ms(500);
    }
}
```

## Proteus仿真配置

### 编码器模拟
在Proteus中可以使用以下方式模拟编码器信号：
1. **脉冲发生器**: 配置频率可调的方波信号源
2. **仿真电机**: 使用带编码器输出的DC电机模型
3. **信号频率**: 根据转速计算
   - 例如: 1000 RPM，20 PPR → 频率 = 1000/60 × 20 = 333.3 Hz

### 接线
```
脉冲源/编码器输出 → PB7 (TIM4_CH2)
```

## 测速范围

### 最大测速
- 受限于中断处理速度
- 建议最大频率: < 10kHz
- 对应转速 (20 PPR): < 30,000 RPM

### 最小测速
- 受限于溢出检测阈值
- 最低频率: > 0.15 Hz
- 对应转速 (20 PPR): > 0.45 RPM

## 调试技巧

### 1. 串口监控
程序已集成串口输出，可实时查看转速数据：
```
RPM: 1234.5, Hz: 411.5
```

### 2. OLED显示
在OLED屏幕上实时显示：
- 第1行: 标题 "Speed Monitor"
- 第2行: RPM值
- 第3行: Hz值

### 3. 常见问题
- **读数为0**: 检查PB7接线，确认有脉冲信号输入
- **读数不稳定**: 增加信号滤波，或降低采样频率
- **读数偏大/偏小**: 检查ENCODER_PPR参数是否正确

## 优势
1. ✅ 硬件简单，只需1根信号线
2. ✅ 适合Proteus仿真
3. ✅ 测量精度高（1us分辨率）
4. ✅ 自动处理定时器溢出
5. ✅ 低速和高速都能准确测量

## 注意事项
1. 必须根据实际电机修改`ENCODER_PPR`参数
2. PB7必须连接到有效的脉冲信号
3. 定时器溢出会影响低速测量，已自动处理
4. 如需更高精度，可增加定时器频率（减小预分频）

## 文件列表
- `SYSTEM/encoder/encoder.h` - 头文件
- `SYSTEM/encoder/encoder.c` - 实现文件
- `USER/main.c` - 主程序示例

## 作者
STM32测速方案 - PB7相位检测版
